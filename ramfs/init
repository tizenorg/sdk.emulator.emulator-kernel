#!/bin/busybox sh
# SeokYeon Hwang (syeon.hwang@samsung.com)

COLOR_BLUE="\033[1;34m" # light blue
COLOR_GREEN="\033[1;32m" # light green
COLOR_RED="\033[1;31m" # light red
NO_COLOR="\033[0m"

NEW_ROOT="/new_root"

cmdline() {
    local value
    value=" $(cat /proc/cmdline) "
    value="${value##* $1=}"
    value="${value%% *}"
    [ "$value" != "" ] && echo "$value"
}

/bin/busybox mkdir -p /dev
/bin/busybox mount -t devtmpfs devtmpfs /dev

exec &> /dev/console

# for debugging...
#/bin/busybox ls -la /dev >> /dev/console

echo -e "${COLOR_GREEN}Preparing...${NO_COLOR}"
/bin/busybox mkdir -p /proc
/bin/busybox mount -t proc proc /proc
/bin/busybox mkdir -p /sys
/bin/busybox mount -t sysfs sys /sys

# for init...
INIT=$(cmdline init)
if [ -z $INIT ]; then
    INIT="/sbin/init"
fi

# mount root...
echo -e "${COLOR_GREEN}Mount image...${NO_COLOR}"
ROOT=$(cmdline root)
if [ -z $ROOT ]; then
    echo -e "${COLOR_BLUE}Mount legacy image...${NO_COLOR}"
    /bin/busybox mount -o rw /dev/vda $NEW_ROOT
else
    echo -e "${COLOR_BLUE}Mount ${ROOT}...${NO_COLOR}"
    /bin/busybox mount -o rw $ROOT $NEW_ROOT
fi

# clean up...
/bin/busybox umount /proc
/bin/busybox umount /sys

echo -e "${COLOR_GREEN}Switching root...${NO_COLOR}"
exec /bin/busybox switch_root -c /dev/console $NEW_ROOT $INIT
